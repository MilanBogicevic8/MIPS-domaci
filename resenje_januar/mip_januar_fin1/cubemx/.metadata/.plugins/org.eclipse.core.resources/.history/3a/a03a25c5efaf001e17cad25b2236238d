/*
 * driver_temp.c
 *
 *  Created on: Jan 6, 2022
 *      Author: Marko Micovic
 */

#include "FreeRTOS.h"
#include "task.h"
#include "queue.h"

#include "adc.h"
#include "gpio.h"


// MAX VOLTAGE = 5V
#define MAX_VOLTAGE 5.0
// ADC RESOLUTION = 2^12 = 4096 (12-bit resolution)
#define RESOLUTION 4096.0

float volatile tempSensor=0;
float volatile windvaneSensor=0;

static void temp_task(void* parameters){
	while(1){
		HAL_GPIO_WritePin(GPIOA, GPIO_PIN_6, GPIO_PIN_RESET);
		HAL_ADC_Start_IT(&hadc1);
		ulTaskNotifyTake(pdTRUE, portMAX_DELAY);

		tempSensor=HAL_ADC_GetValue(&hadc1);
		tempSensor*=100;
		tempSensor*=MAX_VOLTAGE;
		tempSensor/=RESOLUTION;

		HAL_GPIO_WritePin(GPIOA, GPIO_PIN_6, GPIO_PIN_SET);
		HAL_ADC_Start_IT(&hadc1);
		ulTaskNotifyTake(pdTRUE, portMAX_DELAY);

		windvaneSensor*=MAX_VOLTAGE;
		windvaneSensor/=RESOLUTION;
	}
}
